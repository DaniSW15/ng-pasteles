<div class="pedido-create-container">
  <div class="page-header">
    <h1>
      <i class="pi pi-plus-circle"></i>
      Crear Nuevo Pedido
    </h1>
  </div>

  <form [formGroup]="pedidoForm" (ngSubmit)="onSubmit()">
    <p-card>
      <ng-template pTemplate="header">
        <div class="card-header">
          <h3>Detalles del Pedido</h3>
          <p-button 
            label="Agregar Producto" 
            icon="pi pi-plus"
            [outlined]="true"
            type="button"
            (onClick)="agregarDetalle()">
          </p-button>
        </div>
      </ng-template>

      <div formArrayName="detalles" class="detalles-list">
        @for (detalle of detalles.controls; track $index; let i = $index) {
          <div [formGroupName]="i" class="detalle-item">
            <div class="detalle-header">
              <h4>Producto {{ i + 1 }}</h4>
              @if (detalles.length > 1) {
                <p-button 
                  icon="pi pi-trash" 
                  [text]="true"
                  severity="danger"
                  type="button"
                  (onClick)="eliminarDetalle(i)">
                </p-button>
              }
            </div>

            <div class="detalle-fields">
              <div class="field">
                <label>Pastel *</label>
                <select formControlName="pastelId" class="form-control">
                  <option value="">Seleccione un pastel</option>
                  @for (pastel of pastelesStore.pasteles(); track pastel.id) {
                    <option [value]="pastel.id">
                      {{ pastel.nombre }} - {{ pastel.precio | currency: 'USD':'symbol':'1.2-2' }}
                    </option>
                  }
                </select>
                @if (detalle.get('pastelId')?.invalid && detalle.get('pastelId')?.touched) {
                  <small class="error">Seleccione un pastel</small>
                }
              </div>

              <div class="field">
                <label>Cantidad *</label>
                <input 
                  type="number" 
                  formControlName="cantidad" 
                  class="form-control"
                  min="1"
                  placeholder="Cantidad">
                @if (detalle.get('cantidad')?.invalid && detalle.get('cantidad')?.touched) {
                  <small class="error">Cantidad m√≠nima: 1</small>
                }
              </div>

              <div class="field subtotal-field">
                <label>Subtotal</label>
                <div class="subtotal-value">
                  {{ calcularSubtotal(i) | currency: 'USD':'symbol':'1.2-2' }}
                </div>
              </div>
            </div>
          </div>
        }
      </div>

      <ng-template pTemplate="footer">
        <div class="form-footer">
          <div class="total-section">
            <span class="total-label">Total del Pedido:</span>
            <span class="total-value">{{ calcularTotal() | currency: 'USD':'symbol':'1.2-2' }}</span>
          </div>
          <div class="actions">
            <p-button 
              label="Cancelar" 
              icon="pi pi-times"
              [outlined]="true"
              severity="secondary"
              type="button"
              (onClick)="cancelar()">
            </p-button>
            <p-button 
              label="Crear Pedido" 
              icon="pi pi-check"
              type="submit"
              [loading]="loading()"
              [disabled]="pedidoForm.invalid || loading()">
            </p-button>
          </div>
        </div>
      </ng-template>
    </p-card>
  </form>
</div>
